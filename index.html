<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ITC Token Presale</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="fulllogo_transparent_nobuffer.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    .buy-row { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 14px; }
    .buy-row input[type="number"] { width: 48%; padding: 10px; font-size: 1.05rem; border-radius: 10px; border: none; background: #182a47; color: #fafcff; text-align: right; }
    .after-input-label { font-size: 1.08em; color: #b7eaff; font-weight: 600; }
    button:disabled { background: #25344f; color: #b3c0df;}
    /* Retain rest of your CSS as before */
    /* Add your watermark/background/left-side/right-side styling here unchanged */
  </style>
</head>
<body>
  <img src="fulllogo_transparent_nobuffer.png" class="watermark" alt="IT Capitals Watermark" />
  <div class="main-container">
    <div class="left-side">
      <div class="logo-header">
        <img src="fulllogo_transparent_nobuffer.png" alt="IT Capitals Logo"/>
        <h1>IT CAPITALS</h1>
      </div>
      <div class="info-card">
        <strong>Founded:</strong> February 2025<br>
        IT Capitals specializes in <strong>blockchain development</strong> and <strong>DAPP creation</strong>, IT infrastructure solutions, and advanced website management for clients aiming for digital excellence.
      </div>
      <div class="info-card">
        <strong>Introducing ITC Token:</strong><br>
        A utility token for a next-generation digital rewards and services ecosystem.
        <ul>
          <li>Earn by referring clients or using IT Capitals’ solutions</li>
          <li>Redeem ITC for premium services & exclusive features</li>
          <li>Soon: Real-world benefits—partner discounts, events, more</li>
        </ul>
        Join ITC community & unlock unique value in Web3 and IT services.
      </div>
      <div class="info-card thanks-card">
        <strong>With gratitude:</strong><br>
        Special thanks to <span class="highlighted">Mr. MM</span> for visionary ideas and helping build the foundation of IT Capitals.
      </div>
    </div>
    <div class="right-side">
      <div id="presale-widget">
        <h2 style="margin-bottom:13px;">ITC Token Presale</h2>
        <div style="font-size:1.09em;color:#43e6ff;font-weight:600;margin-bottom:10px;">Pay with ETH, PYUSD, or T2TO</div>
        <div style="font-size:1em;color:#8ce0fc;margin-bottom:10px;">1 ITC = <span id="price-info">$?</span></div>
        <div class="buy-row">
          <span class="input-label" style="margin:0;">Buy</span>
          <input type="number" id="itcInput" min="0" step="0.01" placeholder="" autocomplete="off">
          <span class="after-input-label">ITC</span>
        </div>
        <div style="display:flex;gap:8px;justify-content:center;margin-bottom:10px;">
          <button id="actionBtn">Connect Wallet</button>
        </div>
        <div style="display:flex;gap:8px;justify-content:center;">
          <button id="buyETHBtn" disabled>Buy with ETH</button>
          <button id="buyPYUSDBtn" disabled>Buy with PYUSD</button>
          <button id="buyT2TOBtn" disabled>Buy with T2TO</button>
        </div>
        <div id="walletStatus" style="min-height:20px;"></div>
        <div id="buyResult" style="margin-top:13px;min-height:20px;"></div>
      </div>
    </div>
  </div>
  <div id="footer-bar">Powered by IT Capitals, ON, Canada.</div>
<script>
const PRESALE_CONTRACT = "0xd1887abfadc7b5de18c54a547490c8dea792686b";
const PYUSD_ADDRESS = "0xCaC524BcA292aaade2DF8A05cC58F0a65B1B3bB9";
const T2TO_ADDRESS  = "0xDd0C8f1AA8abDb162632F61EdE9b07ffED1eB333";

const presaleAbi = [
  "function getCurrentUSDCPrice() view returns (uint256)",
  "function ethPriceUSDC() view returns (uint256)",
  "function buyWithToken(uint8,uint256) external",
  "function buyWithETH(uint256) external payable",
];
const erc20Abi = [
  "function approve(address spender, uint256 value) external returns (bool)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function balanceOf(address) view returns (uint256)"
];

let provider, signer, user, isConnected = false;
const APPROVE_GAS = 60000, BUY_GAS = 200000;

// --- UI setup
async function updatePriceInfo() {
  try {
    const contract = new ethers.Contract(PRESALE_CONTRACT, presaleAbi, provider || new ethers.providers.Web3Provider(window.ethereum, "any"));
    const priceUSDC = await contract.getCurrentUSDCPrice();
    document.getElementById("price-info").textContent = `$${(Number(priceUSDC) / 1e4).toFixed(2)}`;
  } catch (e) {
    document.getElementById("price-info").textContent = "?";
  }
}

// --- Connect wallet
document.getElementById('actionBtn').onclick = async function() {
  const btn = document.getElementById('actionBtn');
  const status = document.getElementById('walletStatus');
  try {
    if (!window.ethereum) {
      status.textContent = "MetaMask is required.";
      return;
    }
    provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    user = await signer.getAddress();
    isConnected = true;
    btn.textContent = "Wallet Connected";
    status.textContent = "Connected: " + user;
    document.getElementById("buyETHBtn").disabled    = false;
    document.getElementById("buyPYUSDBtn").disabled  = false;
    document.getElementById("buyT2TOBtn").disabled   = false;
    updatePriceInfo();
  } catch (err) {
    status.textContent = "Connect failed: " + (err.message || err);
  }
};

// Buy with ETH
document.getElementById("buyETHBtn").onclick = async function() {
  const itcAmt = document.getElementById('itcInput').value;
  const result = document.getElementById("buyResult");
  result.textContent = "";
  if (!isConnected) return;
  if (!itcAmt || isNaN(itcAmt) || +itcAmt <= 0) {
    result.textContent = "Enter valid ITC amount!";
    return;
  }
  try {
    const contract = new ethers.Contract(PRESALE_CONTRACT, presaleAbi, signer);
    const priceUSDC = await contract.getCurrentUSDCPrice();
    const ethPriceUSDC = await contract.ethPriceUSDC();
    const itcAmountWei = ethers.utils.parseUnits(itcAmt, 18);
    const totalUSDC = ethers.BigNumber.from(priceUSDC).mul(itcAmountWei).div("1000000000000000000");
    const ethRequired = totalUSDC.mul("1000000000000000000").div(ethPriceUSDC);
    const tx = await contract.buyWithETH(itcAmountWei, { value: ethRequired, gasLimit: BUY_GAS });
    result.textContent = "Sent... please confirm/wait";
    await tx.wait();
    result.textContent = "✅ Bought ITC with ETH! TX: " + tx.hash;
  } catch (e) {
    result.textContent = "Error: " + (e && e.message ? e.message : e);
    console.error(e);
  }
};

// Universal buyWithToken helper
async function buyWithToken(tokenAddress, payTokenEnumVal) {
  const itcAmt = document.getElementById('itcInput').value;
  const result = document.getElementById("buyResult");
  result.textContent = "";
  if (!isConnected) return;
  if (!itcAmt || isNaN(itcAmt) || +itcAmt <= 0) {
    result.textContent = "Enter valid ITC amount!";
    return;
  }
  try {
    const contract = new ethers.Contract(PRESALE_CONTRACT, presaleAbi, signer);
    const priceUSDC = await contract.getCurrentUSDCPrice();
    const itcAmountWei = ethers.utils.parseUnits(itcAmt, 18);
    const totalUSDC = ethers.BigNumber.from(priceUSDC).mul(itcAmountWei).div("1000000000000000000");
    const neededAmount = totalUSDC.mul("1000000000000");
    const token = new ethers.Contract(tokenAddress, erc20Abi, signer);
    const balance = await token.balanceOf(user);
    if (balance.lt(neededAmount)) {
      result.textContent = "Not enough token balance!";
      return;
    }
    const allowance = await token.allowance(user, PRESALE_CONTRACT);
    if (allowance.lt(neededAmount)) {
      result.textContent = "Approve tokens in MetaMask...";
      const tx = await token.approve(PRESALE_CONTRACT, neededAmount, { gasLimit: APPROVE_GAS });
      await tx.wait();
      result.textContent = "Approval done, buying tokens...";
    }
    const tx = await contract.buyWithToken(payTokenEnumVal, itcAmountWei, { gasLimit: BUY_GAS });
    result.textContent = "Buying... please confirm/wait";
    await tx.wait();
    result.textContent = "✅ Bought ITC! TX: " + tx.hash;
  } catch (e) {
    result.textContent = "Error: " + (e && e.message ? e.message : e);
    console.error(e);
  }
}

document.getElementById("buyPYUSDBtn").onclick = async function() {
  await buyWithToken(PYUSD_ADDRESS, 2); // PaymentToken.PYUSD = 2
};
document.getElementById("buyT2TOBtn").onclick = async function() {
  await buyWithToken(T2TO_ADDRESS, 1); // PaymentToken.T2TO = 1
};

window.addEventListener('load', ()=> { updatePriceInfo(); });
document.getElementById('itcInput').oninput = function() {
  document.getElementById('buyResult').textContent = "";
};
</script>
</body>
</html>
