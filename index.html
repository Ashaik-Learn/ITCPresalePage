<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ITC Token Presale</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="fulllogo_transparent_nobuffer.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* Preserve your original CSS (not included for brevity; use as before) */
    .buy-row { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 14px; }
    .buy-row input[type="number"] { width: 48%; padding: 10px; font-size: 1.05rem; border-radius: 10px; border: none; background: #182a47; color: #fafcff; text-align: right; }
    .after-input-label { font-size: 1.08em; color: #b7eaff; font-weight: 600; }
    #notif {
      margin-top: 13px;
      margin-bottom: 8px;
      min-height: 24px;
      border-radius: 7px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.01em;
      font-weight: 700;
      width: 100%;
      transition: background 0.2s;
      box-sizing: border-box;
      padding: 4px 8px;
    }
    .notif-info { background: #1f385a; color: #7ed6fd; }
    .notif-success { background: #163c2a; color: #61ffb1; }
    .notif-error { background: #431515; color: #ffa2a2; }
  </style>
</head>
<body>
  <!-- UI remains unchanged below -->
  <img src="fulllogo_transparent_nobuffer.png" class="watermark" alt="IT Capitals Watermark" />
  <div class="main-container">
    <div class="left-side">
      <!-- ...your unchanged content... -->
    </div>
    <div class="right-side">
      <div id="presale-widget">
        <h2 style="margin-bottom:13px;">ITC Token Presale</h2>
        <div style="font-size:1.09em;color:#43e6ff;font-weight:600;margin-bottom:10px;">Pay with ETH, PYUSD, or T2TO</div>
        <div style="font-size:1em;color:#8ce0fc;margin-bottom:10px;">
          <span style="color:#fff;">1 PYUSD = $1.00 = 2 ITC</span>
        </div>
        <div class="buy-row">
          <span class="input-label" style="margin:0;">Buy</span>
          <input type="number" id="itcInput" min="0" step="1" placeholder="">
          <span class="after-input-label">ITC</span>
        </div>
        <button id="actionBtn">Connect Wallet to buy ITC</button>
        <button id="buyETHBtn" disabled>Buy with ETH</button>
        <button id="buyPYUSDBtn" disabled>Buy with PYUSD</button>
        <button id="buyT2TOBtn" disabled>Buy with T2TO</button>
        <div id="walletStatus" style="min-height:20px;"></div>
        <div id="notif"></div>
      </div>
    </div>
  </div>
  <div id="footer-bar">Powered by IT Capitals, ON, Canada.</div>
<script>
const PRESALE_CONTRACT = "0xd1887abfadc7b5de18c54a547490c8dea792686b";
const PYUSD_ADDRESS = "0xCaC524BcA292aaade2DF8A05cC58F0a65B1B3bB9";
const T2TO_ADDRESS  = "0xDd0C8f1AA8abDb162632F61EdE9b07ffED1eB333";

const presaleAbi = [
  "function getCurrentUSDCPrice() view returns (uint256)",
  "function ethPriceUSDC() view returns (uint256)",
  "function buyWithToken(uint8,uint256) external",
  "function buyWithETH(uint256) external payable",
];
const erc20Abi = [
  "function approve(address spender, uint256 value) external returns (bool)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function balanceOf(address) view returns (uint256)"
];
let provider, signer, user, isConnected = false;
const APPROVE_GAS = 70000, BUY_GAS = 180000;

// Notification styling
function showNotif(msg, type = "info") {
  const notif = document.getElementById("notif");
  notif.className = "";
  notif.classList.add(type === "success" ? "notif-success" : type === "error" ? "notif-error" : "notif-info");
  notif.textContent = msg;
  if (msg.trim() === "") notif.style.display = "none"; else notif.style.display = "flex";
}

document.getElementById('actionBtn').onclick = async function() {
  try {
    if (!window.ethereum) return showNotif("MetaMask required!", "error");
    provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    user = await signer.getAddress();
    isConnected = true;
    document.getElementById('actionBtn').textContent = "Wallet Connected";
    document.getElementById("buyETHBtn").disabled = false;
    document.getElementById("buyPYUSDBtn").disabled = false;
    document.getElementById("buyT2TOBtn").disabled = false;
    document.getElementById('walletStatus').innerHTML = `Connected: <span style='color:#6cf;'>${user}</span>`;
    showNotif("Wallet connected! ðŸŽ‰", "success");
  } catch (err) {
    showNotif("Wallet connect failed: " + (err.message || err), "error");
  }
};

document.getElementById('buyETHBtn').onclick = async function() {
  if (!isConnected) return showNotif("Connect wallet first.", "error");
  const itcAmt = document.getElementById('itcInput').value;
  if (!itcAmt || isNaN(itcAmt) || +itcAmt <= 0) return showNotif("Enter a valid ITC amount.", "error");
  try {
    const contract = new ethers.Contract(PRESALE_CONTRACT, presaleAbi, signer);
    const priceUSDC = await contract.getCurrentUSDCPrice(); // contract price still used for ETH/T2TO
    const ethPriceUSDC = await contract.ethPriceUSDC();
    const itcAmountWei = ethers.utils.parseUnits(itcAmt, 18);
    const totalUSDC = ethers.BigNumber.from(priceUSDC).mul(itcAmountWei).div("1000000000000000000");
    const ethRequired = totalUSDC.mul("1000000000000000000").div(ethPriceUSDC);
    const tx = await contract.buyWithETH(itcAmountWei, { value: ethRequired, gasLimit: BUY_GAS });
    showNotif("Sent, awaiting confirmation... â³", "info");
    await tx.wait();
    showNotif("âœ… Bought ITC with ETH! Tx: " + tx.hash.slice(0,10) + "...", "success");
  } catch (e) {
    showNotif("Error: " + (e && e.message ? e.message : "Unknown"), "error");
    console.error(e);
  }
};

async function buyWithToken(tokenAddr, payTokenEnum, priceUSD, tokenName = "TOKEN") {
  if (!isConnected) return showNotif("Connect wallet first.", "error");
  let itcAmt = document.getElementById('itcInput').value;
  if (!itcAmt || isNaN(itcAmt) || +itcAmt <= 0) return showNotif("Enter a valid ITC amount.", "error");

  // PYUSD logic: 1 PYUSD = 2 ITC (so PYUSD needed = ITC/2, and only allow even ITC? or fractional if contract supportsâ€”here support fractional)
  let tokensNeeded, msg;
  if (payTokenEnum === 2) {
    let pyusdExact = (+itcAmt) / 2;
    tokensNeeded = ethers.utils.parseUnits(pyusdExact.toString(), 18);
    msg = `To buy ${itcAmt} ITC, you need ${(+itcAmt/2).toFixed(2)} PYUSD.`;
  } else if (payTokenEnum === 1) {
    // T2TO logic: 1 T2TO (18 decimals) = $0.50; so price is from contract or hardcoded
    let priceUSDC = priceUSD ?? 50000; // 6 decimals = $0.50
    const itcAmountWei = ethers.utils.parseUnits(itcAmt, 18);
    const totalUSDC = ethers.BigNumber.from(priceUSDC).mul(itcAmountWei).div("1000000000000000000");
    tokensNeeded = totalUSDC.mul("1000000000000"); // 1e12 to get 18 decimals
    msg = `To buy ${itcAmt} ITC, you need ${ethers.utils.formatUnits(tokensNeeded,18)} T2TO.`;
  }
  try {
    const token = new ethers.Contract(tokenAddr, erc20Abi, signer);
    const balance = await token.balanceOf(user);
    if (balance.lt(tokensNeeded)) return showNotif(`Not enough ${tokenName} in wallet for this amount.`, "error");
    const allowance = await token.allowance(user, PRESALE_CONTRACT);
    if (allowance.lt(tokensNeeded)) {
      showNotif(`Approve ${tokenName} in MetaMask... ðŸ”„`, "info");
      const tx = await token.approve(PRESALE_CONTRACT, tokensNeeded, { gasLimit: APPROVE_GAS });
      await tx.wait();
      showNotif(`${tokenName} approved! Now submitting buy...`, "info");
    }
    const tx = await (new ethers.Contract(PRESALE_CONTRACT, presaleAbi, signer)).buyWithToken(payTokenEnum, ethers.utils.parseUnits(itcAmt, 18), { gasLimit: BUY_GAS });
    showNotif(`Buying... awaiting confirmation â³`, "info");
    await tx.wait();
    showNotif(`âœ… Bought ITC with ${tokenName}! Tx: ${tx.hash.slice(0,10)}...`, "success");
  } catch (e) {
    showNotif("Error: " + (e && e.message ? e.message : "Unknown"), "error");
    console.error(e);
  }
}

document.getElementById('buyPYUSDBtn').onclick = async function() { 
  buyWithToken(PYUSD_ADDRESS, 2, null, "PYUSD");
};
document.getElementById('buyT2TOBtn').onclick = async function() {
  // T2TO hardcoded price $0.50 (6 decimals)
  buyWithToken(T2TO_ADDRESS, 1, 50000, "T2TO");
};

document.getElementById('itcInput').oninput = ()=>showNotif("");
</script>
</body>
</html>
